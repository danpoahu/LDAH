<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>LDAH - Analytics Dashboard</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      background: url('https://danpoahu.github.io/LDAH/background.png') no-repeat center center fixed;
      background-size: cover;
      min-height: 100vh;
    }
    .stat-card {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 16px;
      padding: 24px;
      border: 2px solid #004E7C;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .chart-container {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin-top: 16px;
    }
    @media print {
      body {
        background: white;
      }
      .no-print {
        display: none !important;
      }
      .stat-card {
        page-break-inside: avoid;
        border: 1px solid #004E7C;
      }
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAU3CQ07bCVKlJ1qGak-150kaJEyPKldLk",
      authDomain: "ldah-932d5.firebaseapp.com",
      projectId: "ldah-932d5",
      storageBucket: "ldah-932d5.firebasestorage.app",
      messagingSenderId: "662130454003",
      appId: "1:662130454003:web:437576d5a5811ecd8df686"
    };

    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }

    const db = firebase.firestore();
    const auth = firebase.auth();

    auth.signInAnonymously().catch(error => {
      console.error('Anonymous auth failed:', error);
    });

    const AnalyticsDashboard = () => {
      const [dateRange, setDateRange] = useState('year'); // month, quarter, year, custom
      const [startDate, setStartDate] = useState('');
      const [endDate, setEndDate] = useState('');
      const [loading, setLoading] = useState(false);
      
      // Data states
      const [analytics, setAnalytics] = useState(null);
      const [events, setEvents] = useState([]);
      const [volunteers, setVolunteers] = useState([]);
      const [eventSignups, setEventSignups] = useState([]);

      const loadAllData = async () => {
        setLoading(true);
        try {
          // Load analytics events
          const analyticsSnapshot = await db.collection('analytics').get();
          const analyticsData = analyticsSnapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data()
          }));
          
          // Load events
          const eventsSnapshot = await db.collection('events').get();
          const eventsData = eventsSnapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data()
          }));
          
          // Load all event signups
          let allSignups = [];
          for (const event of eventsData) {
            const signupsSnapshot = await db.collection('events').doc(event.id).collection('signups').get();
            const signups = signupsSnapshot.docs.map(doc => ({
              id: doc.id,
              eventId: event.id,
              eventTitle: event.title,
              ...doc.data()
            }));
            allSignups = [...allSignups, ...signups];
          }
          
          // Load volunteer applications
          const volunteersSnapshot = await db.collection('volunteers').get();
          const volunteersData = volunteersSnapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data()
          }));

          setAnalytics(analyticsData);
          setEvents(eventsData);
          setEventSignups(allSignups);
          setVolunteers(volunteersData);
        } catch (error) {
          console.error('Error loading data:', error);
          alert('Error loading data: ' + error.message);
        }
        setLoading(false);
      };

      const getDateRangeFilter = () => {
        const now = new Date();
        let start, end;

        switch(dateRange) {
          case 'month':
            start = new Date(now.getFullYear(), now.getMonth(), 1);
            end = new Date(now.getFullYear(), now.getMonth() + 1, 0);
            break;
          case 'quarter':
            const quarter = Math.floor(now.getMonth() / 3);
            start = new Date(now.getFullYear(), quarter * 3, 1);
            end = new Date(now.getFullYear(), quarter * 3 + 3, 0);
            break;
          case 'year':
            start = new Date(now.getFullYear(), 0, 1);
            end = new Date(now.getFullYear(), 11, 31);
            break;
          case 'custom':
            start = startDate ? new Date(startDate) : new Date(now.getFullYear(), 0, 1);
            end = endDate ? new Date(endDate) : now;
            break;
          default:
            start = new Date(now.getFullYear(), 0, 1);
            end = now;
        }

        return { start, end };
      };

      const filterByDateRange = (items, dateField = 'timestamp') => {
        const { start, end } = getDateRangeFilter();
        
        return items.filter(item => {
          let itemDate;
          
          if (item[dateField]?.seconds) {
            itemDate = new Date(item[dateField].seconds * 1000);
          } else if (item[dateField]) {
            itemDate = new Date(item[dateField]);
          } else {
            return false;
          }
          
          return itemDate >= start && itemDate <= end;
        });
      };

      const calculateMetrics = () => {
        if (!analytics && !eventSignups.length && !volunteers.length) {
          return null;
        }

        const { start, end } = getDateRangeFilter();
        
        // Filter data by date range
        const filteredSignups = filterByDateRange(eventSignups, 'timestamp');
        const filteredVolunteers = filterByDateRange(volunteers, 'submittedAt');
        const filteredAnalytics = analytics ? filterByDateRange(analytics, 'timestamp') : [];

        // Calculate page views
        const pageViews = filteredAnalytics.filter(a => a.eventType === 'page_view').length;
        
        // Calculate event signups
        const totalEventSignups = filteredSignups.length;
        const totalEventVolunteers = filteredSignups.reduce((total, signup) => {
          if (signup.participationType === 'Group' && signup.groupSize) {
            return total + parseInt(signup.groupSize);
          }
          return total + 1;
        }, 0);

        // Calculate volunteer applications
        const totalVolunteerApps = filteredVolunteers.length;
        
        // Event breakdown
        const eventBreakdown = {};
        filteredSignups.forEach(signup => {
          if (!eventBreakdown[signup.eventTitle]) {
            eventBreakdown[signup.eventTitle] = {
              signups: 0,
              volunteers: 0
            };
          }
          eventBreakdown[signup.eventTitle].signups += 1;
          if (signup.participationType === 'Group' && signup.groupSize) {
            eventBreakdown[signup.eventTitle].volunteers += parseInt(signup.groupSize);
          } else {
            eventBreakdown[signup.eventTitle].volunteers += 1;
          }
        });

        // Volunteer status breakdown
        const volunteerStatus = {
          new: 0,
          read: 0,
          contacted: 0,
          'in-progress': 0,
          approved: 0,
          rejected: 0
        };
        filteredVolunteers.forEach(vol => {
          if (volunteerStatus.hasOwnProperty(vol.status)) {
            volunteerStatus[vol.status]++;
          }
        });

        // Monthly trends
        const monthlyData = {};
        filteredSignups.forEach(signup => {
          const date = signup.timestamp?.seconds 
            ? new Date(signup.timestamp.seconds * 1000)
            : new Date(signup.timestamp);
          const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
          
          if (!monthlyData[monthKey]) {
            monthlyData[monthKey] = { signups: 0, volunteers: 0 };
          }
          
          monthlyData[monthKey].signups += 1;
          if (signup.participationType === 'Group' && signup.groupSize) {
            monthlyData[monthKey].volunteers += parseInt(signup.groupSize);
          } else {
            monthlyData[monthKey].volunteers += 1;
          }
        });

        return {
          dateRange: { start, end },
          pageViews,
          totalEventSignups,
          totalEventVolunteers,
          totalVolunteerApps,
          eventBreakdown,
          volunteerStatus,
          monthlyData
        };
      };

      const generateReport = () => {
        const metrics = calculateMetrics();
        if (!metrics) return;

        const { start, end } = metrics.dateRange;
        const startStr = start.toLocaleDateString();
        const endStr = end.toLocaleDateString();

        let report = `LDAH ANALYTICS REPORT\n`;
        report += `Period: ${startStr} - ${endStr}\n`;
        report += `Generated: ${new Date().toLocaleString()}\n\n`;
        
        report += `=== OVERVIEW ===\n`;
        report += `Total Page Views: ${metrics.pageViews}\n`;
        report += `Event Signups: ${metrics.totalEventSignups}\n`;
        report += `Total Event Volunteers: ${metrics.totalEventVolunteers}\n`;
        report += `Volunteer Applications: ${metrics.totalVolunteerApps}\n\n`;
        
        report += `=== EVENT BREAKDOWN ===\n`;
        Object.entries(metrics.eventBreakdown).forEach(([event, data]) => {
          report += `${event}:\n`;
          report += `  - Signups: ${data.signups}\n`;
          report += `  - Volunteers: ${data.volunteers}\n`;
        });
        
        report += `\n=== VOLUNTEER APPLICATIONS STATUS ===\n`;
        Object.entries(metrics.volunteerStatus).forEach(([status, count]) => {
          report += `${status}: ${count}\n`;
        });
        
        report += `\n=== MONTHLY TRENDS ===\n`;
        Object.entries(metrics.monthlyData).sort().forEach(([month, data]) => {
          report += `${month}: ${data.signups} signups, ${data.volunteers} volunteers\n`;
        });

        // Download as text file
        const blob = new Blob([report], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `LDAH_Analytics_Report_${startStr.replace(/\//g, '-')}_to_${endStr.replace(/\//g, '-')}.txt`;
        link.click();
      };

      const exportToCSV = () => {
        const metrics = calculateMetrics();
        if (!metrics) return;

        const { start, end } = metrics.dateRange;
        let csv = `LDAH Analytics Report\n`;
        csv += `Period,${start.toLocaleDateString()} - ${end.toLocaleDateString()}\n\n`;
        
        csv += `Metric,Value\n`;
        csv += `Page Views,${metrics.pageViews}\n`;
        csv += `Event Signups,${metrics.totalEventSignups}\n`;
        csv += `Total Event Volunteers,${metrics.totalEventVolunteers}\n`;
        csv += `Volunteer Applications,${metrics.totalVolunteerApps}\n\n`;
        
        csv += `\nEvent Breakdown\n`;
        csv += `Event Name,Signups,Volunteers\n`;
        Object.entries(metrics.eventBreakdown).forEach(([event, data]) => {
          csv += `"${event}",${data.signups},${data.volunteers}\n`;
        });
        
        csv += `\nVolunteer Application Status\n`;
        csv += `Status,Count\n`;
        Object.entries(metrics.volunteerStatus).forEach(([status, count]) => {
          csv += `${status},${count}\n`;
        });
        
        csv += `\nMonthly Trends\n`;
        csv += `Month,Signups,Volunteers\n`;
        Object.entries(metrics.monthlyData).sort().forEach(([month, data]) => {
          csv += `${month},${data.signups},${data.volunteers}\n`;
        });

        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `LDAH_Analytics_${new Date().toISOString().split('T')[0]}.csv`;
        link.click();
      };

      useEffect(() => {
        loadAllData();
      }, []);

      if (loading) {
        return (
          <div className="min-h-screen flex items-center justify-center">
            <div className="text-center">
              <div className="text-4xl mb-4">‚è≥</div>
              <p className="text-[#004E7C] font-bold">Loading analytics data...</p>
            </div>
          </div>
        );
      }

      const metrics = calculateMetrics();

      return (
        <div className="min-h-screen p-4">
          <div className="max-w-6xl mx-auto">
            {/* Header */}
            <div className="stat-card mb-6">
              <div className="flex justify-between items-center mb-4">
                <h1 className="text-3xl font-bold text-[#004E7C]">
                  Analytics Dashboard
                </h1>
                <a
                  href="admin.html"
                  className="no-print px-4 py-2 bg-gray-500 text-white rounded-lg font-semibold hover:bg-gray-600 transition-colors"
                >
                  ‚Üê Back to Admin
                </a>
              </div>

              {/* Date Range Selector */}
              <div className="flex flex-wrap gap-3 items-center mb-4">
                <select
                  value={dateRange}
                  onChange={(e) => setDateRange(e.target.value)}
                  className="px-4 py-2 border-2 border-gray-300 rounded-lg font-semibold"
                >
                  <option value="month">This Month</option>
                  <option value="quarter">This Quarter</option>
                  <option value="year">This Year</option>
                  <option value="custom">Custom Range</option>
                </select>

                {dateRange === 'custom' && (
                  <>
                    <input
                      type="date"
                      value={startDate}
                      onChange={(e) => setStartDate(e.target.value)}
                      className="px-4 py-2 border-2 border-gray-300 rounded-lg"
                    />
                    <span className="font-semibold text-gray-600">to</span>
                    <input
                      type="date"
                      value={endDate}
                      onChange={(e) => setEndDate(e.target.value)}
                      className="px-4 py-2 border-2 border-gray-300 rounded-lg"
                    />
                  </>
                )}

                <button
                  onClick={loadAllData}
                  className="no-print px-4 py-2 bg-[#004E7C] text-white rounded-lg font-semibold hover:bg-[#003a5c] transition-colors"
                >
                  üîÑ Refresh Data
                </button>
              </div>

              {/* Export Buttons */}
              <div className="flex gap-3 no-print">
                <button
                  onClick={generateReport}
                  className="px-6 py-2 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition-colors"
                >
                  üìÑ Download Report (.txt)
                </button>
                <button
                  onClick={exportToCSV}
                  className="px-6 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition-colors"
                >
                  üìä Export CSV
                </button>
                <button
                  onClick={() => window.print()}
                  className="px-6 py-2 bg-purple-600 text-white rounded-lg font-semibold hover:bg-purple-700 transition-colors"
                >
                  üñ®Ô∏è Print Report
                </button>
              </div>

              {metrics && (
                <div className="mt-4 text-sm text-gray-600">
                  Report Period: {metrics.dateRange.start.toLocaleDateString()} - {metrics.dateRange.end.toLocaleDateString()}
                </div>
              )}
            </div>

            {metrics ? (
              <>
                {/* Key Metrics Cards */}
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                  <div className="stat-card text-center">
                    <div className="text-4xl mb-2">üëÅÔ∏è</div>
                    <div className="text-3xl font-bold text-[#004E7C]">
                      {metrics.pageViews}
                    </div>
                    <div className="text-sm text-gray-600 font-semibold">Page Views</div>
                  </div>

                  <div className="stat-card text-center">
                    <div className="text-4xl mb-2">üìÖ</div>
                    <div className="text-3xl font-bold text-[#004E7C]">
                      {metrics.totalEventSignups}
                    </div>
                    <div className="text-sm text-gray-600 font-semibold">Event Signups</div>
                  </div>

                  <div className="stat-card text-center">
                    <div className="text-4xl mb-2">üë•</div>
                    <div className="text-3xl font-bold text-[#004E7C]">
                      {metrics.totalEventVolunteers}
                    </div>
                    <div className="text-sm text-gray-600 font-semibold">Event Volunteers</div>
                  </div>

                  <div className="stat-card text-center">
                    <div className="text-4xl mb-2">ü§ù</div>
                    <div className="text-3xl font-bold text-[#004E7C]">
                      {metrics.totalVolunteerApps}
                    </div>
                    <div className="text-sm text-gray-600 font-semibold">Volunteer Apps</div>
                  </div>
                </div>

                {/* Event Breakdown */}
                <div className="stat-card mb-6">
                  <h2 className="text-2xl font-bold text-[#004E7C] mb-4">Event Breakdown</h2>
                  {Object.keys(metrics.eventBreakdown).length > 0 ? (
                    <div className="space-y-3">
                      {Object.entries(metrics.eventBreakdown).map(([event, data]) => (
                        <div key={event} className="bg-gray-50 p-4 rounded-lg">
                          <h3 className="font-bold text-gray-900 mb-2">{event}</h3>
                          <div className="flex gap-6 text-sm">
                            <div>
                              <span className="text-gray-600">Signups:</span>
                              <span className="font-bold text-[#004E7C] ml-2">{data.signups}</span>
                            </div>
                            <div>
                              <span className="text-gray-600">Volunteers:</span>
                              <span className="font-bold text-[#004E7C] ml-2">{data.volunteers}</span>
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                  ) : (
                    <p className="text-gray-600">No events in this period</p>
                  )}
                </div>

                {/* Volunteer Application Status */}
                <div className="stat-card mb-6">
                  <h2 className="text-2xl font-bold text-[#004E7C] mb-4">Volunteer Applications Status</h2>
                  <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
                    {Object.entries(metrics.volunteerStatus).map(([status, count]) => (
                      <div key={status} className="bg-gray-50 p-3 rounded-lg text-center">
                        <div className="text-2xl font-bold text-[#004E7C]">{count}</div>
                        <div className="text-xs text-gray-600 font-semibold capitalize">{status}</div>
                      </div>
                    ))}
                  </div>
                </div>

                {/* Monthly Trends */}
                <div className="stat-card">
                  <h2 className="text-2xl font-bold text-[#004E7C] mb-4">Monthly Trends</h2>
                  {Object.keys(metrics.monthlyData).length > 0 ? (
                    <div className="space-y-2">
                      {Object.entries(metrics.monthlyData).sort().map(([month, data]) => (
                        <div key={month} className="flex justify-between items-center bg-gray-50 p-3 rounded-lg">
                          <span className="font-semibold text-gray-900">{month}</span>
                          <div className="flex gap-4 text-sm">
                            <span className="text-gray-600">
                              Signups: <span className="font-bold text-[#004E7C]">{data.signups}</span>
                            </span>
                            <span className="text-gray-600">
                              Volunteers: <span className="font-bold text-[#004E7C]">{data.volunteers}</span>
                            </span>
                          </div>
                        </div>
                      ))}
                    </div>
                  ) : (
                    <p className="text-gray-600">No data in this period</p>
                  )}
                </div>
              </>
            ) : (
              <div className="stat-card text-center py-12">
                <p className="text-gray-600 text-lg">No data available</p>
              </div>
            )}
          </div>
        </div>
      );
    };

    ReactDOM.render(<AnalyticsDashboard />, document.getElementById('root'));
  </script>
</body>
</html>
